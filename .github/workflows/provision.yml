name: Provision Intern Resources
on:
  issues:
    types: [opened]

permissions:
  issues: write
  contents: read

jobs:
  provision:
    # 1. Safety Check: Only run if the issue title matches exactly
    if: contains(github.event.issue.title, 'Start Onboarding')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Run Provisioning Script
        uses: actions/github-script@v6
        env:
          # CONFIGURATION
          TEMPLATE_REPO: 'curriculum-template'
          NEW_REPO_PREFIX: 'spring-lab-'
        with:
          # CRITICAL: Ensure this matches your Secret name exactly. PAT expires 1/8/2027.
          github-token: ${{ secrets.ORG_ADMIN_TOKEN }}
          script: |
            const user = context.payload.issue.user.login;
            const org = context.repo.owner;
            const templateRepo = process.env.TEMPLATE_REPO;
            const newRepoName = `${process.env.NEW_REPO_PREFIX}${user}`;

            console.log(`üöÄ Starting provisioning for @${user}...`);

            // --- START GLOBAL TRY BLOCK ---
            try { 

              // Step 1: Create the new repository (With its own mini Try/Catch)
              try {
                await github.rest.repos.createUsingTemplate({
                  template_owner: org,
                  template_repo: templateRepo,
                  name: newRepoName,
                  owner: org,
                  private: true,
                  include_all_branches: false 
                });
                console.log(`‚úÖ Repository ${newRepoName} created.`);
              } catch (createError) {
                // Error 422 = Repo already exists (Unprocessable Entity)
                if (createError.status === 422) {
                  console.log(`‚ÑπÔ∏è Repository ${newRepoName} already exists.`); 
                  console.log(`   --> Skipping creation and proceeding to check permissions.`);
                } else {
                  throw createError; // Throw other errors up to the Global Catch
                }
              }

              // Step 2: Add the intern to the new repository (Write Access)
              await github.rest.repos.addCollaborator({
                owner: org,
                repo: newRepoName,
                username: user,
                permission: 'push' 
              });
              console.log(`‚úÖ User @${user} added to repo.`);

              // Step 3: Attempt to Invite to Organization
              try {
                await github.rest.orgs.setMembershipForUser({
                  org: org,
                  username: user,
                  role: 'member'
                });
                console.log(`‚úÖ User @${user} invited to Organization.`);
              } catch (err) {
                console.log(`‚ÑπÔ∏è Note on Org Invite: ${err.message}`);
              }

              // Step 4: Check if we already welcomed them (Spam Protection)
              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });

              const alreadyWelcomed = comments.data.find(comment => 
                comment.body.includes(`üöÄ Welcome to the Team, @${user}`)
              );

              if (alreadyWelcomed) {
                console.log(`‚ú® User @${user} has already been welcomed. Skipping comment.`);
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: `## üöÄ Welcome to the Team, @${user}!\n\nYour coding environment is ready.\n\n### 1Ô∏è‚É£ Accept your Invite\nCheck your email or [GitHub Notifications](https://github.com/notifications) to accept the invitation to the Organization.\n\n### 2Ô∏è‚É£ Start Coding\nYour private repository is located here:\n**üëâ https://github.com/${org}/${newRepoName}**\n\n*(This issue will now automatically close)*`
                });
                console.log(`‚úÖ Welcome message posted.`);
              }

              // Step 5: Close the Issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                state: 'closed'
              });

            } catch (error) {
              // --- GLOBAL CATCH BLOCK ---
              console.log(`‚ùå FATAL ERROR: ${error.message}`);
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `‚ö†Ô∏è **Provisioning Failed**\n\nError: \`${error.message}\`\n\nPlease tag an instructor for help.`
              });
              core.setFailed(error.message);
            }
